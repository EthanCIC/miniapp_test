<script>
    let tg = window.Telegram?.WebApp;
    let gameArea = document.getElementById('gameArea');
    let startButton = document.getElementById('startButton');
    let shakeButton = document.getElementById('shakeButton');
    let scoreDisplay = document.getElementById('score');
    let sensitivitySlider = document.getElementById('sensitivity');
    let sensitivityValue = document.getElementById('sensitivityValue');
    let feverOverlay = document.getElementById('feverOverlay');
    let score = 0;
    let isGameRunning = false;
    let baseVibrationInterval = 1000;
    let vibrationInterval = baseVibrationInterval;
    let lastVibrationTime = 0;
    let isVibrating = false;
    let gameTimer;
    let canScore = false;
    let lastShakeTime = 0;
    let shakeThreshold = 2;
    let isDesktop = !('ontouchstart' in window);

    let lastAcceleration = 0;
    let shakeState = 'idle';
    let lastDirectionChangeTime = 0;
    let minShakeInterval = 300;
    const MIN_POSSIBLE_INTERVAL = 100;

    let baseJudgmentWindow = 500;
    let judgmentWindow = baseJudgmentWindow;

    let isFeverMode = false;
    let feverTimer;
    let feverVibrationTimer;

    if (tg) tg.ready();

    function startGame() {
        if (isGameRunning) return;
        isGameRunning = true;
        score = 0;
        vibrationInterval = baseVibrationInterval;
        minShakeInterval = 300;
        judgmentWindow = baseJudgmentWindow;
        isFeverMode = false;
        feverOverlay.style.display = 'none';
        scoreDisplay.textContent = `Score: ${score}`;
        gameArea.textContent = "Get ready...";
        startButton.disabled = true;
        if (isDesktop) {
            shakeButton.style.display = 'block';
            shakeButton.disabled = false;
        }
        
        setTimeout(() => {
            gameArea.textContent = isDesktop ? "Click 'Shake!' when you see the circle!" : "Shake when you see the circle!";
            lastVibrationTime = Date.now();
            gameTimer = setInterval(gameLoop, 100);
        }, 2000);
    }

    function gameLoop() {
        let currentTime = Date.now();
        if (currentTime - lastVibrationTime >= vibrationInterval) {
            vibrate();
            showCircle();
            lastVibrationTime = currentTime;
            isVibrating = true;
            canScore = true;
            setTimeout(() => {
                if (canScore) {
                    updateScore(-1);
                    gameArea.textContent = "Missed shake! -1";
                }
                isVibrating = false;
                canScore = false;
            }, judgmentWindow);
        }
    }

    function vibrate() {
        if (tg?.HapticFeedback) {
            tg.HapticFeedback.impactOccurred('heavy');
        }
    }

    function showCircle() {
        let circle = document.createElement('div');
        circle.className = 'circle';
        gameArea.appendChild(circle);
        setTimeout(() => {
            gameArea.removeChild(circle);
        }, 500);
    }

    function endGame() {
        isGameRunning = false;
        clearInterval(gameTimer);
        clearTimeout(feverTimer);
        clearInterval(feverVibrationTimer);
        isFeverMode = false;
        feverOverlay.style.display = 'none';
        gameArea.textContent = `Game Over! Your score: ${score}`;
        startButton.disabled = false;
        if (isDesktop) {
            shakeButton.style.display = 'none';
        }
    }

    function handleShake() {
        if (!isGameRunning) return;

        let currentTime = Date.now();

        if (isFeverMode) {
            updateScore(1);
            gameArea.textContent = `FEVER!!! Score: ${score}`;
            return;
        }

        if (currentTime - lastShakeTime > minShakeInterval) {
            lastShakeTime = currentTime;
            if (isVibrating && canScore && (currentTime - lastVibrationTime <= judgmentWindow)) {
                updateScore(1);
                canScore = false;
                gameArea.textContent = "Good shake! +1";
            } else if (!isVibrating) {
                updateScore(-1);
                gameArea.textContent = "Bad timing! -1";
            }
        }
    }

    function updateScore(change) {
        score += change;
        scoreDisplay.textContent = `Score: ${score}`;
        if (score >= 15 && !isFeverMode) {
            startFeverMode();
        } else if (!isFeverMode) {
            updateVibrationInterval();
        }
    }

    function updateVibrationInterval() {
        vibrationInterval = Math.max(MIN_POSSIBLE_INTERVAL, baseVibrationInterval - (Math.floor(score / 2) * 50));
        minShakeInterval = Math.max(MIN_POSSIBLE_INTERVAL, 300 - (Math.floor(score / 3) * 10));
        judgmentWindow = Math.max(MIN_POSSIBLE_INTERVAL, baseJudgmentWindow - (score * 10));
    }

    function startFeverMode() {
        isFeverMode = true;
        feverOverlay.style.display = 'flex';
        gameArea.textContent = "FEVER!!! Shake as fast as you can!";
        clearInterval(gameTimer);
        feverTimer = setTimeout(endFeverMode, 10000);
        
        // Start continuous vibration
        feverVibrationTimer = setInterval(() => {
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }, 200);  // Vibrate every 200 milliseconds
    }

    function endFeverMode() {
        isFeverMode = false;
        feverOverlay.style.display = 'none';
        clearInterval(feverVibrationTimer);
        gameArea.textContent = "Fever ended! Continue normal play.";
        lastVibrationTime = Date.now();
        gameTimer = setInterval(gameLoop, 100);
        updateVibrationInterval();
    }

    startButton.addEventListener('click', startGame);
    shakeButton.addEventListener('click', handleShake);

    sensitivitySlider.addEventListener('input', function() {
        shakeThreshold = (30 - this.value) / 5;
        sensitivityValue.textContent = this.value;
    });

    setTimeout(endGame, 30000);
</script>
