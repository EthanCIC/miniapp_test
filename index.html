<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved Shake Match Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* 保持之前的样式不变 */
    </style>
</head>
<body>
    <div id="gameArea">Press Start to begin</div>
    <button id="startButton">Start Game</button>
    <div id="score">Score: 0</div>
    <div id="sensitivityControl">
        <label for="sensitivity">Shake Sensitivity:</label>
        <input type="range" id="sensitivity" min="10" max="30" value="20">
        <span id="sensitivityValue">20</span>
    </div>

    <script>
        // 保持之前的大部分代码不变，只修改 handleShake 函数和添加一些新变量

        let tg = window.Telegram.WebApp;
        let gameArea = document.getElementById('gameArea');
        let startButton = document.getElementById('startButton');
        let scoreDisplay = document.getElementById('score');
        let sensitivitySlider = document.getElementById('sensitivity');
        let sensitivityValue = document.getElementById('sensitivityValue');
        let score = 0;
        let isGameRunning = false;
        let currentInterval = 1000;
        let lastShakeTime = 0;
        let vibrationPattern = [];
        let patternIndex = 0;
        let lastShakeMagnitude = 0;
        let shakeThreshold = 20;

        tg.expand();

        // 保持其他函数不变: startGame, generateVibrationPattern, playVibrationPattern, endGame

        function handleShake(event) {
            if (!isGameRunning) return;

            let acceleration = event.accelerationIncludingGravity;
            let shakeMagnitude = Math.sqrt(acceleration.x ** 2 + acceleration.y ** 2 + acceleration.z ** 2);
            
            // 计算加速度变化
            let shakeDelta = Math.abs(shakeMagnitude - lastShakeMagnitude);
            lastShakeMagnitude = shakeMagnitude;

            if (shakeDelta > shakeThreshold) {
                let currentTime = Date.now();
                let timeSinceLastVibration = currentTime - lastShakeTime;
                
                // 检查摇动是否在震动的200ms内发生
                if (Math.abs(timeSinceLastVibration - currentInterval) < 200) {
                    score++;
                    scoreDisplay.textContent = `Score: ${score}`;
实现，    gameArea.textContent = `Good shake! Magnitude: ${shakeDelta.toFixed(2)}`;
                } else {
                    gameArea.textContent = `Try to match the vibration timing! Magnitude: ${shakeDelta.toFixed(2)}`;
                }
            }
        }

        startButton.addEventListener('click', startGame);

        sensitivitySlider.addEventListener('input', function() {
            shakeThreshold = this.value;
            sensitivityValue.textContent = this.value;
        });

        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', handleShake, false);
        } else {
            gameArea.textContent = "Device motion not supported on this device";
        }
    </script>
</body>
</html>