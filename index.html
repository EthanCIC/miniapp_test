<script>
    // Define global variables
    let tg = window.Telegram?.WebApp;
    let gameArea = document.getElementById('gameArea');
    let startButton = document.getElementById('startButton');
    let shakeButton = document.getElementById('shakeButton');
    let scoreDisplay = document.getElementById('score');
    let sensitivitySlider = document.getElementById('sensitivity');
    let sensitivityValue = document.getElementById('sensitivityValue');
    let feverOverlay = document.getElementById('feverOverlay');
    let score = 0;
    let isGameRunning = false;
    let isFeverMode = false;
    let lastShakeTime = 0;
    let shakeThreshold = 2;
    let isDesktop = !('ontouchstart' in window);

    if (tg) tg.ready();

    // Function to start the game
    function startGame() {
        if (isGameRunning) return;
        isGameRunning = true;
        score = 0;
        isFeverMode = false;
        feverOverlay.style.display = 'none';
        scoreDisplay.textContent = `Score: ${score}`;
        gameArea.textContent = "Get ready...";
        startButton.disabled = true;
        shakeButton.style.display = isDesktop ? 'block' : 'none';

        setTimeout(() => {
            gameArea.textContent = isDesktop ? "Click 'Shake!' when you see the circle!" : "Shake when you see the circle!";
        }, 2000);
    }

    // Function to handle shake events
    function handleShake() {
        if (!isGameRunning) return;

        let currentTime = Date.now();

        if (isFeverMode && currentTime - lastShakeTime >= 200) {  // Ensure at least 200 ms between shakes
            updateScore(1);
            lastShakeTime = currentTime;
            gameArea.textContent = `FEVER!!! Score: ${score}`;
        }
    }

    // Update score function
    function updateScore(change) {
        score += change;
        scoreDisplay.textContent = `Score: ${score}`;
        if (score >= 10 && !isFeverMode) {
            startFeverMode();
        }
    }

    // Start FEVER mode
    function startFeverMode() {
        isFeverMode = true;
        feverOverlay.style.display = 'flex';
        gameArea.textContent = "FEVER!!! Shake as fast as you can!";
    }

    // Event listeners for the start button and shake button
    startButton.addEventListener('click', startGame);
    shakeButton.addEventListener('click', handleShake);

    // Device motion permission request for mobile devices
    function requestMotionPermission() {
        if (typeof DeviceMotionEvent?.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('devicemotion', handleShakeMotion, false);
                        startGame();
                    }
                })
                .catch(console.error);
        } else {
            window.addEventListener('devicemotion', handleShakeMotion, false);
            startGame();
        }
    }

    // Handle device motion
    function handleShakeMotion(event) {
        let acceleration = event.accelerationIncludingGravity;
        let shakeMagnitude = Math.sqrt(acceleration.x ** 2 + acceleration.y ** 2 + acceleration.z ** 2);

        if (shakeMagnitude > shakeThreshold) {
            handleShake();
        }
    }

    sensitivitySlider.addEventListener('input', function() {
        shakeThreshold = (30 - this.value) / 5;
        sensitivityValue.textContent = this.value;
    });
</script>
