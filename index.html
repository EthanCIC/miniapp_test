<script>
    // Define global variables
    let tg = window.Telegram?.WebApp;
    let gameArea = document.getElementById('gameArea');
    let startButton = document.getElementById('startButton');
    let shakeButton = document.getElementById('shakeButton');
    let scoreDisplay = document.getElementById('score');
    let sensitivitySlider = document.getElementById('sensitivity');
    let sensitivityValue = document.getElementById('sensitivityValue');
    let feverOverlay = document.getElementById('feverOverlay');
    let score = 0;
    let isGameRunning = false;
    let isFeverMode = false;
    let lastShakeTime = 0;
    let shakeThreshold = 15; // Adjust this threshold based on sensitivity settings
    let isDesktop = !('ontouchstart' in window);

    if (tg) tg.ready();

    function startGame() {
        if (isGameRunning) return;
        isGameRunning = true;
        score = 0;
        isFeverMode = false;
        feverOverlay.style.display = 'none';
        scoreDisplay.textContent = `Score: ${score}`;
        gameArea.textContent = "Get ready...";
        startButton.disabled = true;
        shakeButton.style.display = isDesktop ? 'block' : 'none';

        setTimeout(() => {
            gameArea.textContent = isDesktop ? "Click 'Shake!' when you see the circle!" : "Shake when you see the circle!";
            if (!isDesktop) {
                window.addEventListener('devicemotion', handleShakeMotion, false);
            }
        }, 2000);
    }

    function handleShake() {
        if (!isGameRunning || !isFeverMode) return;

        let currentTime = Date.now();
        if (currentTime - lastShakeTime >= 200) { // Ensure at least 200 ms between shakes
            lastShakeTime = currentTime;
            updateScore(1);
            gameArea.textContent = `FEVER!!! Score: ${score}`;
        }
    }

    function updateScore(change) {
        score += change;
        scoreDisplay.textContent = `Score: ${score}`;
        if (score >= 10 && !isFeverMode) {
            startFeverMode();
        }
    }

    function startFeverMode() {
        isFeverMode = true;
        feverOverlay.style.display = 'flex';
        gameArea.textContent = "FEVER!!! Shake as fast as you can!";
    }

    startButton.addEventListener('click', startGame);
    shakeButton.addEventListener('click', handleShake);

    function requestMotionPermission() {
        if (typeof DeviceMotionEvent?.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        startGame();
                    }
                })
                .catch(console.error);
        } else {
            startGame();
        }
    }

    function handleShakeMotion(event) {
        let acceleration = event.accelerationIncludingGravity;
        let shakeMagnitude = Math.sqrt(acceleration.x ** 2 + acceleration.y ** 2 + acceleration.z ** 2);

        if (shakeMagnitude > shakeThreshold) {
            handleShake();
        }
    }

    sensitivitySlider.addEventListener('input', function() {
        shakeThreshold = (30 - this.value) / 5;  // Adjust sensitivity to make it easier or harder to trigger shakes
        sensitivityValue.textContent = this.value;
    });

    if (isDesktop) {
        shakeButton.addEventListener('click', handleShake);
    } else {
        requestMotionPermission();
    }
</script>
